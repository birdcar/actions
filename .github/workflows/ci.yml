name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      actions: ${{ steps.changes.outputs.actions }}
      test-all: ${{ steps.changes.outputs.test-all }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
      matrix: ${{ steps.changes.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Detect changed actions
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            bun run scripts/detect-changes.ts "origin/${{ github.base_ref }}"
          else
            bun run scripts/detect-changes.ts "HEAD~1"
          fi

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Lint
        run: bun run lint

  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build all actions
        run: bun run build

  test:
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run tests with coverage
        id: test
        run: |
          # Run tests with coverage and capture output
          bun test --coverage 2>&1 | tee coverage-output.txt

          # Extract the coverage table for the summary
          echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Get coverage table (lines after "Coverage report:")
          sed -n '/^-*$/,/^$/p' coverage-output.txt | head -50 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Generate coverage report
        id: coverage
        run: |
          # Parse the coverage output into markdown table
          echo "coverage<<EOF" >> $GITHUB_OUTPUT

          echo "## Test Coverage Report" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT

          # Check which actions were tested
          ACTIONS='${{ needs.detect-changes.outputs.actions }}'
          TEST_ALL='${{ needs.detect-changes.outputs.test-all }}'

          if [ "$TEST_ALL" = "true" ]; then
            echo "**Scope:** All actions (shared code or config changed)" >> $GITHUB_OUTPUT
          else
            echo "**Scope:** Changed actions only" >> $GITHUB_OUTPUT
            echo "**Actions tested:** $ACTIONS" >> $GITHUB_OUTPUT
          fi

          echo "" >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          cat coverage-output.txt >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read coverage output
            const coverageOutput = fs.readFileSync('coverage-output.txt', 'utf8');

            // Parse change detection info
            const actions = JSON.parse('${{ needs.detect-changes.outputs.actions }}' || '[]');
            const testAll = '${{ needs.detect-changes.outputs.test-all }}' === 'true';

            // Build the comment body
            let body = '## ðŸ§ª Test Coverage Report\n\n';

            if (testAll) {
              body += '**Scope:** All actions (shared code or config changed)\n\n';
            } else if (actions.length > 0) {
              body += `**Scope:** Changed actions only\n`;
              body += `**Actions tested:** ${actions.join(', ')}\n\n`;
            } else {
              body += '**Scope:** No actions changed\n\n';
            }

            body += '```\n';
            body += coverageOutput;
            body += '\n```\n';

            body += '\n---\n';
            body += '*Generated by CI workflow*';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Test Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

  test-actions:
    runs-on: ubuntu-latest
    needs: [build, test]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test create-release action loads
        run: |
          node actions/create-release/dist/index.js || true
